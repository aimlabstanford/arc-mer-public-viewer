<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARC Working Group IV - MER2 Grant Table</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #8B1538 0%, #2e1a47 100%);
            color: white;
            padding: 30px 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .header-logo {
            height: 70px;
            margin-right: 40px;
            flex-shrink: 0;
        }
        
        .header-content {
            flex: 1;
            text-align: center;
            padding: 0 40px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header h2 {
            font-size: 1.3em;
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin: -40px auto 30px;
            max-width: 1200px;
            position: relative;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .stat-value {
            font-size: 2.8em;
            font-weight: 700;
            background: linear-gradient(135deg, #8B1538, #2e1a47);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            color: #666;
            margin-top: 12px;
            font-size: 0.95em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .methodology-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-left: 4px solid #8B1538;
        }
        
        .methodology-card h3 {
            color: #2e1a47;
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 600;
        }
        
        .methodology-card p {
            color: #495057;
            line-height: 1.8;
            margin-bottom: 15px;
            font-size: 0.95em;
        }
        
        .methodology-card p:last-child {
            margin-bottom: 0;
        }
        
        .table-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .table-container h3 {
            color: #2e1a47;
            margin-bottom: 25px;
            font-size: 1.6em;
            border-bottom: 3px solid #8B1538;
            padding-bottom: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9em;
        }
        
        thead tr:first-child th {
            background: linear-gradient(135deg, #8B1538 0%, #2e1a47 100%);
            color: white;
            padding: 14px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.95em;
            border-right: 1px solid rgba(255,255,255,0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        thead tr:first-child th:last-child {
            border-right: none;
        }
        
        /* Create vertical separator lines for specialty columns */
        thead tr:first-child th:nth-child(6),
        thead tr:first-child th:nth-child(9),
        thead tr:first-child th:nth-child(12),
        thead tr:first-child th:nth-child(15),
        thead tr:first-child th:nth-child(18) {
            border-left: 2px solid rgba(255,255,255,0.3);
        }
        
        thead tr:nth-child(2) th {
            background: #f8f9fa;
            color: #495057;
            padding: 10px 6px;
            text-align: center;
            font-weight: 500;
            font-size: 0.85em;
            border-bottom: 2px solid #dee2e6;
            border-right: 1px solid #e9ecef;
            position: sticky;
            top: 48px;
            z-index: 9;
        }
        
        /* Vertical separators for sub-headers */
        thead tr:nth-child(2) th:nth-child(3n) {
            border-right: 2px solid #dee2e6;
        }
        
        tbody td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
            border-right: 1px solid #f5f5f5;
            text-align: center;
            color: #352f36;
        }
        
        /* Clickable cells for grants and publications */
        tbody td.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: underline;
            text-decoration-color: #8B153833;
            text-underline-offset: 2px;
        }
        
        tbody td.clickable:hover {
            color: #8B1538;
            font-weight: 600;
            background-color: #f8f9fa;
            text-decoration-color: #8B1538;
            transform: scale(1.05);
        }
        
        /* Expanded detail row */
        .detail-row {
            display: none;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .detail-row td {
            padding: 20px 30px;
            text-align: left;
            border-top: 3px solid #8B1538;
            border-bottom: 2px solid #dee2e6;
        }
        
        .detail-content {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .detail-content h4 {
            color: #8B1538;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        .detail-content p {
            margin: 10px 0;
            color: #495057;
            line-height: 1.6;
        }
        
        .detail-content strong {
            color: #2e1a47;
        }
        
        .detail-content ul {
            list-style: none;
            padding: 0;
        }
        
        .detail-content li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        
        .detail-content li:before {
            content: '•';
            position: absolute;
            left: 0;
            color: #8B1538;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        @keyframes highlight {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffe69c; }
            100% { background-color: #f8f9fa; }
        }
        
        /* Vertical column separators - after each specialty's Eff % column */
        tbody td:nth-child(5),
        tbody td:nth-child(8),
        tbody td:nth-child(11),
        tbody td:nth-child(14),
        tbody td:nth-child(17),
        tbody td:nth-child(20) {
            border-right: 2px solid #dee2e6;
        }
        
        tbody td:first-child {
            text-align: left;
            font-weight: 500;
            color: #2e1a47;
        }
        
        tbody td:nth-child(2) {
            text-align: left;
            color: #6c757d;
            font-size: 0.85em;
        }
        
        /* Alternating row backgrounds */
        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        
        tbody tr:hover {
            background: linear-gradient(90deg, #e8f4ff 0%, #f0f8ff 50%, #e8f4ff 100%);
        }
        
        .category-header {
            background: linear-gradient(90deg, #dee2e6 0%, #e9ecef 100%);
            color: #2e1a47;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9em;
        }
        
        .category-header td:first-child {
            font-weight: 700;
        }
        
        .category-header td {
            padding: 10px 8px;
            border-bottom: 2px solid #8B1538;
            border-top: 1px solid #8B1538;
            text-align: center;
            color: #352f36 !important;
            font-size: 0.9em;
            font-weight: normal;
        }
        
        .category-header td:first-child {
            text-align: left;
            padding-left: 15px;
            font-weight: 700;
            font-size: 0.9em;
        }
        
        .total-row {
            background: linear-gradient(135deg, #8B1538 0%, #2e1a47 100%);
            color: white;
            font-weight: 700;
        }
        
        .total-row td {
            padding: 14px 8px;
            border: none;
            font-size: 1.05em;
            color: white !important;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }
        
        .error {
            background: #fee;
            color: #c00;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .table-container { padding: 15px; }
            table { font-size: 0.8em; }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="aim-logo-white.png" alt="AIM Lab" class="header-logo" onerror="this.style.display='none'">
        <div class="header-content">
            <h1>ARC Working Group IV</h1>
            <h2>NIH Medical Education Research (MER2) Grants and Publications Online Table Viewer</h2>
            <p style="font-size: 1.1em; margin-top: 10px;">Created by Larry Chu, MD</p>
            <p style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">Fiscal Years 2014-2024 Analysis</p>
        </div>
    </div>
    
    <div class="container">
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="totalGrants">-</div>
                <div class="stat-label">Total MER2 Grants</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalPubs">-</div>
                <div class="stat-label">Total Publications</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pubsPerGrant">-</div>
                <div class="stat-label">Pubs per Grant</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalMechanisms">-</div>
                <div class="stat-label">Mechanisms</div>
            </div>
        </div>
        
        <div class="methodology-card">
            <h3>Methodology</h3>
            <p>In response to reviewer feedback, we developed a grant-anchored pathway to assess productivity and ROI. This was not part of the original design because most medical education scholarship in anesthesiology is not tied to extramural grants, grant identification is challenging (e.g., K23 awards may indirectly support education projects), and not all funded projects yield education research publications. We identified Medical Education Research (MER2) grants using refined classification criteria based on NIH's project_terms field across six specialties. Publications were retrieved from PubMed using grant numbers, enabling linkage of outputs to their funding sources and measurement of MER impact.</p>
            <p style="margin-top: 20px; font-style: italic;">— Stanford AIM Lab Team<br>Alex Goodell, MD, Dara Rouholiman, BS, Larry Chu, MD</p>
        </div>
        
        <div class="table-container">
            <h3>Table 1: NIH Grants and Publications by Funding Mechanism</h3>
            <div id="loadingMessage" class="loading">Loading data...</div>
            <div id="errorMessage" class="error" style="display: none;"></div>
            <table id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th rowspan="2">Grant Mechanism</th>
                        <th rowspan="2">Description</th>
                        <th colspan="3">Anesthesiology</th>
                        <th colspan="3">Emergency Medicine</th>
                        <th colspan="3">Surgery</th>
                        <th colspan="3">Internal Medicine</th>
                        <th colspan="3">OB/GYN</th>
                        <th colspan="3">Pediatrics</th>
                        <th colspan="3">TOTAL</th>
                    </tr>
                    <tr>
                        <th># Grants</th><th># Pubs</th><th>Eff %</th>
                        <th># Grants</th><th># Pubs</th><th>Eff %</th>
                        <th># Grants</th><th># Pubs</th><th>Eff %</th>
                        <th># Grants</th><th># Pubs</th><th>Eff %</th>
                        <th># Grants</th><th># Pubs</th><th>Eff %</th>
                        <th># Grants</th><th># Pubs</th><th>Eff %</th>
                        <th>Grants</th><th>Pubs</th><th>Eff %</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // Load data from JSON file
        async function loadData() {
            try {
                // Try to load detailed data first, fall back to simple data
                let response = await fetch('data/arc_mer2_detailed_data.json?v=' + Date.now());
                if (!response.ok) {
                    console.log('Detailed data not found, falling back to simple data');
                    response = await fetch('data/arc_mer2_public_data.json?v=' + Date.now());
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const jsonData = await response.json();
                
                // Extract the MER data and mechanism descriptions
                if (!jsonData || !jsonData.data) {
                    throw new Error('Invalid data structure in JSON file');
                }
                
                const merData = jsonData.data;
                const mechanismDescriptions = jsonData.mechanismDescriptions || {};
                
                // Store globally for detail views
                window.lastMerData = merData;
                window.lastMechanismDescriptions = mechanismDescriptions;
                
                console.log('Loaded data:', jsonData);
                console.log('MER data specialties:', Object.keys(merData));
                console.log('Mechanism descriptions available:', Object.keys(mechanismDescriptions).length);
                
                // Validate data structure
                if (Object.keys(merData).length === 0) {
                    throw new Error('No specialty data found in JSON');
                }
                
                // Calculate statistics
                calculateStatistics(merData);
                
                // Build the table
                buildTable(merData, mechanismDescriptions);
                
                // Hide loading message and show table
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').innerHTML = 
                    `Error loading data: ${error.message}<br>
                     <small>Please ensure the data file is available at data/arc_mer2_public_data.json</small>`;
            }
        }
        
        // Calculate and display statistics
        function calculateStatistics(merData) {
            let totalGrants = 0;
            let totalPubs = 0;
            const allMechanisms = new Set();
            
            for (const specialty of Object.values(merData)) {
                for (const [mechanism, counts] of Object.entries(specialty)) {
                    allMechanisms.add(mechanism);
                    totalGrants += counts.grants;
                    totalPubs += counts.publications;
                }
            }
            
            document.getElementById('totalGrants').textContent = totalGrants.toLocaleString();
            document.getElementById('totalPubs').textContent = totalPubs.toLocaleString();
            document.getElementById('pubsPerGrant').textContent = (totalPubs / totalGrants).toFixed(1);
            document.getElementById('totalMechanisms').textContent = allMechanisms.size;
        }
        
        // Get all unique mechanisms
        function getAllMechanisms(merData) {
            const mechanisms = new Set();
            for (const specialty of Object.values(merData)) {
                for (const mechanism of Object.keys(specialty)) {
                    mechanisms.add(mechanism);
                }
            }
            return Array.from(mechanisms).sort();
        }
        
        // Build the table
        function buildTable(merData, mechanismDescriptions) {
            try {
                const tbody = document.getElementById('tableBody');
                let html = '';
                const allMechanisms = getAllMechanisms(merData);
                console.log('All mechanisms found:', allMechanisms);
            
            // Category groupings
            const categories = {
                'Research Grants': ['R01', 'R03', 'R13', 'R15', 'R16', 'R18', 'R21', 'R24', 'R25', 'R33', 'R34', 'R35', 'R37', 'R38', 'R50', 'R56', 'R61', 'R00', 'RM1'],
                'Career Development': ['K01', 'K02', 'K05', 'K07', 'K08', 'K12', 'K18', 'K22', 'K23', 'K24', 'K26', 'K43', 'K99', 'KL2'],
                'Training': ['T15', 'T32', 'T35', 'TL1', 'F30', 'F31', 'F32'],
                'Cooperative Agreements': ['U01', 'U10', 'U13', 'U19', 'U24', 'U2C', 'U34', 'U41', 'U54', 'UE5', 'UG1', 'UG3', 'UH2', 'UH3', 'UL1', 'UM1'],
                'Centers': ['P01', 'P20', 'P30', 'P42', 'P50', 'P51', 'P60'],
                'Other': ['D43', 'DP2', 'DP3', 'DP5', 'G08', 'G11', 'G12', 'G13', 'S10']
            };
            
            const specialties = ['ANESTHESIOLOGY', 'EMERGENCY MEDICINE', 'SURGERY', 'INTERNAL MEDICINE', 'OBSTETRICS & GYNECOLOGY', 'PEDIATRICS'];
            
            // Track category totals
            const categoryTotals = {};
            
            // Group mechanisms by category
            for (const [category, mechanisms] of Object.entries(categories)) {
                console.log(`Processing category: ${category}`);
                let categoryRows = '';
                let catTotals = {};
                specialties.forEach(s => catTotals[s] = {grants: 0, pubs: 0});
                
                for (const mechanism of mechanisms) {
                    if (!allMechanisms.includes(mechanism)) continue;
                    console.log(`  Processing mechanism: ${mechanism}`);
                    
                    let row = `<tr>
                        <td>${mechanism}</td>
                        <td>${mechanismDescriptions[mechanism] || 'N/A'}</td>`;
                    
                    let totalGrants = 0;
                    let totalPubs = 0;
                    
                    for (const specialty of specialties) {
                        try {
                            const data = merData[specialty]?.[mechanism] || {grants: 0, publications: 0};
                            const grants = data.grants;
                            const pubs = data.publications;
                        const efficiency = grants > 0 ? ((pubs / grants) * 100).toFixed(0) : '0';
                        
                        // Only make cells clickable if they have data
                        const grantCell = grants > 0 
                            ? `<td class="clickable" onclick="toggleDetails('${mechanism}', '${specialty}', 'grants', event)">${grants}</td>`
                            : `<td>-</td>`;
                        const pubCell = pubs > 0 
                            ? `<td class="clickable" onclick="toggleDetails('${mechanism}', '${specialty}', 'pubs', event)">${pubs}</td>`
                            : `<td>-</td>`;
                        
                        row += grantCell + pubCell + `<td>${grants > 0 ? efficiency + '%' : '-'}</td>`;
                        
                        catTotals[specialty].grants += grants;
                        catTotals[specialty].pubs += pubs;
                        totalGrants += grants;
                        totalPubs += pubs;
                        } catch (innerError) {
                            console.error(`Error processing ${specialty} - ${mechanism}:`, innerError);
                            console.error('merData[specialty]:', merData[specialty]);
                        }
                    }
                    
                    const totalEfficiency = totalGrants > 0 ? ((totalPubs / totalGrants) * 100).toFixed(0) : '0';
                    row += `<td><strong>${totalGrants}</strong></td>
                            <td><strong>${totalPubs}</strong></td>
                            <td><strong>${totalGrants > 0 ? totalEfficiency + '%' : '-'}</strong></td>`;
                    row += '</tr>';
                    
                    categoryRows += row;
                }
                
                // Add category header and rows if there's data
                if (categoryRows) {
                    // Category header
                    let catTotal = 0;
                    let catPubTotal = 0;
                    let headerRow = `<tr class="category-header">
                        <td colspan="2">${category.toUpperCase()}</td>`;
                    
                    for (const specialty of specialties) {
                        const eff = catTotals[specialty].grants > 0 ? 
                            ((catTotals[specialty].pubs / catTotals[specialty].grants) * 100).toFixed(0) : '0';
                        headerRow += `<td>${catTotals[specialty].grants}</td>
                                     <td>${catTotals[specialty].pubs}</td>
                                     <td>${catTotals[specialty].grants > 0 ? eff + '%' : '-'}</td>`;
                        catTotal += catTotals[specialty].grants;
                        catPubTotal += catTotals[specialty].pubs;
                    }
                    
                    const catEff = catTotal > 0 ? ((catPubTotal / catTotal) * 100).toFixed(0) : '0';
                    headerRow += `<td>${catTotal}</td>
                                 <td>${catPubTotal}</td>
                                 <td>${catTotal > 0 ? catEff + '%' : '-'}</td>`;
                    headerRow += '</tr>';
                    
                    html += headerRow + categoryRows;
                    categoryTotals[category] = {grants: catTotal, pubs: catPubTotal};
                }
            }
            
            // Add total row
            let totalRow = '<tr class="total-row"><td>TOTAL</td><td>All Mechanisms</td>';
            let grandTotalGrants = 0;
            let grandTotalPubs = 0;
            
            // Calculate totals for each specialty column
            for (const specialty of specialties) {
                let specGrants = 0;
                let specPubs = 0;
                
                for (const mechanism of allMechanisms) {
                    const data = merData[specialty]?.[mechanism] || {grants: 0, publications: 0};
                    specGrants += data.grants;
                    specPubs += data.publications;
                }
                
                const specEff = specGrants > 0 ? ((specPubs / specGrants) * 100).toFixed(0) : '0';
                totalRow += `<td>${specGrants}</td>
                            <td>${specPubs}</td>
                            <td>${specGrants > 0 ? specEff + '%' : '-'}</td>`;
                
                grandTotalGrants += specGrants;
                grandTotalPubs += specPubs;
            }
            
            // Add grand total column
            const grandEff = grandTotalGrants > 0 ? ((grandTotalPubs / grandTotalGrants) * 100).toFixed(0) : '0';
            totalRow += `<td>${grandTotalGrants}</td>
                        <td>${grandTotalPubs}</td>
                        <td>${grandEff}%</td></tr>`;
            
            html += totalRow;
            tbody.innerHTML = html;
            } catch (error) {
                console.error('Error in buildTable:', error);
                throw error;
            }
        }
        
        function scrollToGrant(grantId, specialty, mechanism) {
            console.log('scrollToGrant called:', grantId, specialty, mechanism);
            
            // Close any currently open publication details
            document.querySelectorAll('.detail-row').forEach(row => {
                if (row.id.includes('-publications')) {
                    row.style.display = 'none';
                }
            });
            
            // Check if grants detail section exists and is open
            const detailRowId = `detail-${mechanism}-${specialty.replace(/[^A-Za-z]/g, '')}-grants`;
            let detailRow = document.getElementById(detailRowId);
            
            if (!detailRow) {
                // Need to create the grants detail row
                // Find the mechanism row
                const rows = document.querySelectorAll('tbody tr:not(.detail-row)');
                let targetRow = null;
                
                for (let row of rows) {
                    if (row.cells[0] && row.cells[0].textContent.trim() === mechanism) {
                        targetRow = row;
                        break;
                    }
                }
                
                if (targetRow) {
                    // Create the detail row
                    detailRow = document.createElement('tr');
                    detailRow.id = detailRowId;
                    detailRow.className = 'detail-row';
                    detailRow.style.display = 'table-row';
                    
                    const detailCell = document.createElement('td');
                    detailCell.colSpan = targetRow.cells.length;
                    detailCell.innerHTML = createDetailContent(mechanism, specialty, 'grants', detailRowId);
                    
                    detailRow.appendChild(detailCell);
                    targetRow.parentNode.insertBefore(detailRow, targetRow.nextSibling);
                    
                    // Now scroll to the specific grant
                    setTimeout(() => {
                        const grantElement = document.getElementById(`grant-${grantId}`);
                        if (grantElement) {
                            grantElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            grantElement.style.animation = 'highlight 2s';
                        }
                    }, 100);
                }
            } else {
                // Detail row exists, make sure it's visible
                detailRow.style.display = 'table-row';
                
                // Scroll to the specific grant
                setTimeout(() => {
                    const grantElement = document.getElementById(`grant-${grantId}`);
                    if (grantElement) {
                        grantElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        grantElement.style.animation = 'highlight 2s';
                    }
                }, 100);
            }
        }
        
        function getSpecialtyColumnIndex(specialty) {
            const specialtyMap = {
                'INTERNAL MEDICINE': 1,
                'PEDIATRICS': 4,
                'SURGERY': 7,
                'OBSTETRICS & GYNECOLOGY': 10,
                'ANESTHESIOLOGY': 13,
                'EMERGENCY MEDICINE': 16
            };
            return specialtyMap[specialty] || -1;
        }
        
        function toggleDetails(mechanism, specialty, type, event) {
            try {
                console.log('toggleDetails called:', mechanism, specialty, type);
                
                // Prevent event bubbling
                if (event) {
                    event.stopPropagation();
                }
                
                // Create unique ID for the detail row
                const detailRowId = `detail-${mechanism}-${specialty.replace(/[^A-Za-z]/g, '')}-${type}`;
                let detailRow = document.getElementById(detailRowId);
                
                if (detailRow) {
                    // Toggle existing detail row
                    detailRow.style.display = detailRow.style.display === 'none' ? 'table-row' : 'none';
                    return;
                }
                
                // Find the clicked row
                const clickedCell = event ? event.target : document.querySelector(`td.clickable`);
                const clickedRow = clickedCell.closest('tr');
                
                // Create new detail row
                detailRow = document.createElement('tr');
                detailRow.id = detailRowId;
                detailRow.className = 'detail-row';
                detailRow.style.display = 'table-row';
                
                // Get the number of columns to span
                const numColumns = clickedRow.cells.length;
                
                // Create detail cell that spans all columns
                const detailCell = document.createElement('td');
                detailCell.colSpan = numColumns;
                detailCell.innerHTML = createDetailContent(mechanism, specialty, type, detailRowId);
                
                detailRow.appendChild(detailCell);
                
                // Insert the detail row after the clicked row
                clickedRow.parentNode.insertBefore(detailRow, clickedRow.nextSibling);
            } catch (error) {
                console.error('Error in toggleDetails:', error);
                alert('Error showing details: ' + error.message);
            }
        }
        
        function createDetailContent(mechanism, specialty, type, detailRowId) {
            const merData = window.lastMerData; // Store data globally for access
            const data = merData?.[specialty]?.[mechanism];
            
            if (!data) {
                return `<div class="detail-content">
                    <h4>No data available</h4>
                </div>`;
            }
            
            let content = '<div class="detail-content">';
            
            if (type === 'grants') {
                const grantCount = data.grants || 0;
                const grantDetails = data.grant_details || [];
                
                content += `
                    <h4>${mechanism} Grants in ${specialty}</h4>
                    <p><strong>Total Grants:</strong> ${grantCount}</p>
                    <p><strong>Grant Type:</strong> ${window.lastMechanismDescriptions?.[mechanism] || 'N/A'}</p>
                `;
                
                if (grantDetails.length > 0) {
                    content += `<div style="margin-top: 20px;">`;
                    
                    grantDetails.forEach((grant, index) => {
                        content += `
                            <div id="grant-${grant.core_project_num}" style="margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-left: 4px solid #8B1538; border-radius: 4px;">
                                <h5 style="color: #8B1538; margin-bottom: 10px;">
                                    ${index + 1}. ${grant.title || 'Grant ' + grant.core_project_num}
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                    <div><strong>Grant ID:</strong> ${grant.core_project_num || grant.application_id || 'N/A'}</div>
                                    <div><strong>PI:</strong> ${grant.pi_names || 'N/A'}</div>
                                    <div><strong>Amount:</strong> $${(grant.amount || 0).toLocaleString()}</div>
                                    <div><strong>Year:</strong> ${grant.fiscal_year || 'N/A'}</div>
                                </div>
                                ${grant.start_date || grant.end_date ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong>Period:</strong> ${grant.start_date || 'N/A'} to ${grant.end_date || 'N/A'}
                                    </div>
                                ` : ''}
                                ${grant.terms ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong>Topics:</strong> ${grant.terms}
                                    </div>
                                ` : ''}
                                ${grant.abstract ? `
                                    <details style="margin-top: 10px;">
                                        <summary style="cursor: pointer; color: #8B1538; font-weight: 600;">
                                            View Abstract
                                        </summary>
                                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 0.9em; line-height: 1.6;">
                                            ${grant.abstract}
                                        </div>
                                    </details>
                                ` : ''}
                                ${grant.public_health_relevance ? `
                                    <details style="margin-top: 10px;">
                                        <summary style="cursor: pointer; color: #8B1538; font-weight: 600;">
                                            Public Health Relevance
                                        </summary>
                                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 0.9em; line-height: 1.6;">
                                            ${grant.public_health_relevance}
                                        </div>
                                    </details>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    if (grantCount > grantDetails.length) {
                        content += `
                            <p style="font-style: italic; color: #666; margin-top: 15px;">
                                Showing ${grantDetails.length} of ${grantCount} grants. 
                                ${grantCount - grantDetails.length} additional grants not displayed.
                            </p>
                        `;
                    }
                    
                    content += `</div>`;
                } else {
                    content += `
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                            <p style="font-style: italic; color: #666;">
                                Detailed grant information is being loaded. Please check back later.
                            </p>
                        </div>
                    `;
                }
            } else if (type === 'pubs') {
                const pubCount = data.publications || 0;
                const pubDetails = data.publication_details || [];
                const efficiency = data.grants > 0 ? (data.publications / data.grants).toFixed(2) : '0';
                
                content += `
                    <h4>Publications from ${mechanism} Grants in ${specialty}</h4>
                    <p><strong>Total Publications:</strong> ${pubCount}</p>
                    <p><strong>Publications per Grant:</strong> ${efficiency}</p>
                `;
                
                if (pubDetails.length > 0) {
                    content += `<div style="margin-top: 20px;">`;
                    
                    pubDetails.forEach((pub, index) => {
                        const pmidLink = pub.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${pub.pmid}/` : '';
                        const doiLink = pub.doi ? `https://doi.org/${pub.doi}` : '';
                        
                        content += `
                            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-left: 4px solid #2e1a47; border-radius: 4px;">
                                <h5 style="color: #2e1a47; margin-bottom: 10px;">
                                    ${index + 1}. ${pub.title || 'Publication'}
                                </h5>
                                <div style="margin-bottom: 8px;">
                                    <strong>Authors:</strong> ${pub.authors || 'N/A'}
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong>Journal:</strong> ${pub.journal || 'N/A'} 
                                    ${pub.year ? `(${pub.year})` : ''}
                                </div>
                                <div style="margin-top: 10px;">
                                    ${pmidLink ? `
                                        <a href="${pmidLink}" target="_blank" 
                                           style="display: inline-block; margin-right: 15px; padding: 5px 10px; 
                                                  background: #8B1538; color: white; text-decoration: none; 
                                                  border-radius: 4px; font-size: 0.9em;">
                                            PubMed ID: ${pub.pmid}
                                        </a>
                                    ` : ''}
                                    ${doiLink ? `
                                        <a href="${doiLink}" target="_blank" 
                                           style="display: inline-block; padding: 5px 10px; 
                                                  background: #2e1a47; color: white; text-decoration: none; 
                                                  border-radius: 4px; font-size: 0.9em;">
                                            DOI: ${pub.doi}
                                        </a>
                                    ` : ''}
                                </div>
                                ${pub.funding_grant ? `
                                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-left: 3px solid #4caf50; border-radius: 4px;">
                                        <strong style="color: #2e7d32;">Funded by Grant:</strong>
                                        <a href="#grant-${pub.funding_grant.core_project_num}" 
                                           onclick="scrollToGrant('${pub.funding_grant.core_project_num}', '${specialty}', '${mechanism}'); return false;"
                                           style="color: #8B1538; text-decoration: none; font-weight: 600;">
                                            ${pub.funding_grant.core_project_num || 'N/A'}
                                        </a>
                                        <span style="color: #666; margin-left: 10px;">
                                            (${pub.funding_grant.grant_year || 'N/A'}) - PI: ${pub.funding_grant.grant_pi || 'N/A'}
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    if (pubCount > pubDetails.length) {
                        content += `
                            <p style="font-style: italic; color: #666; margin-top: 15px;">
                                Showing ${pubDetails.length} of ${pubCount} publications. 
                                ${pubCount - pubDetails.length} additional publications not displayed.
                            </p>
                        `;
                    }
                    
                    content += `</div>`;
                } else {
                    content += `
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                            <p style="font-style: italic; color: #666;">
                                Detailed publication information is being loaded. Please check back later.
                            </p>
                        </div>
                    `;
                }
            }
            
            content += `
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="document.getElementById('${detailRowId}').style.display='none'" 
                            style="padding: 8px 20px; background: linear-gradient(135deg, #8B1538, #2e1a47); 
                                   color: white; border: none; border-radius: 6px; cursor: pointer;
                                   font-size: 14px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                   transition: all 0.3s ease;"
                            onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)'"
                            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'">
                        Close Details
                    </button>
                </div>
            </div>`;
            
            return content;
        }
        
        // Make function available globally
        window.toggleDetails = toggleDetails;
        
        // Test function
        function testClick() {
            alert('Click is working!');
        }
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, calling loadData...');
            loadData();
        });
    </script>
</body>
</html>